@*
    For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
     ViewBag.Title = "RH";
}

@section scripts {



    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.min.js"></script>

    <!--Reference the SignalR library. -->
    <script src="http://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:8989/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $.connection.hub.url = "http://localhost:8989/signalr";

            var rhHub = $.connection.rhHub;

        $(function () {

            

            rhHub.client.daListaEmpresas = function (val) {
                console.log("Connection started! client");
                console.log(val);
                $("#listaEmpresas").empty();

                val.forEach(preencherEmpresas);

                function preencherEmpresas(value, index, ar) {

                    $("#listaEmpresas").append(
                        $('<li>').append(
                            $('<a>').attr('onclick',"daFuncionarios('"+ value.codigo +"')").append(value.codigo)

                        )
                    );
                }
            };

            rhHub.client.daDadosEmpresa = function (val) {
                console.log("Connection started! - da dados da empresa "+ val.codigo);

                $("#listaFuncionarios").show();

                $("#codigoEmpresa").empty();
                $("#nomeEmpresa").empty();
                $("#nuitEmpresa").empty();

                $("#codigoEmpresa").text(val.codigo);
                $("#nomeEmpresa").text(val.nome);
                $("#nuitEmpresa").text(val.nuit);
            };

            rhHub.client.daListaFuncionarios = function (val) {
                console.log("Connection started! client - Lista Funcionarios");
                console.log(val);
                $("#tableListaFuncionarios").empty();

                $("#tableListaFuncionarios").append("<tr> <th> Codigo  </th> <th> Funcionario </th> <th> Departamento </th>  <th> Email </th> <th> Nr. Telefone</th> </tr>");

                val.forEach(preencheFuncionarios);

                function preencheFuncionarios(value, index, ar){

                    var funcionarios="";

                    //value.contacto.forEach(daContactos)

                    $("#tableListaFuncionarios").append("<tr> <td><a href='#' onclick= daExtratoPdfCliente('" + $("#codigoEmpresa").text() + "','" + value.codigo + "')>" + value.codigo + "</a> </td>" +
                        " <td> " + value.nome + " </td> <td> Primavera</td> <td id='email'>" + value.email + " </td>  <td>   " + value.departamento + "</td>" + "</tr>");

                    //function daContactos(value, index, ar){
                    //    if (value != null) {
                    //        contacto = contacto + value.Email + "; ";
                    //    }

                    //}

                     console.log();
                }


            }

            $.connection.hub.start().done(function () {
                rhHub.server.daListaEmpresas(0, "gmahota", "Accsys2011!", "");
                console.log("connection started! server");


            });
        });

        function enviaEmail(cliente,ficheiro) {
            $.ajax({
                type: "Post",
                url: "/RH/EnviaEmail",
                data: { client: cliente, ficheiro: ficheiro  },
                datatypr: "html",
                success: function (data) {
                    $("#enviaEmail_" + cliente).append("<p>" +data.Message+"</p>");

                }

            });

        }


        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

        function daFuncionarios(empresa){
                console.log("da Lista de Funcionarios da empresa " + empresa);
                rhHub.server.daDadosEmpresa(0, empresa, "gmahota", "Accsys2011!");
                rhHub.server.daListaFuncionarios(0, empresa, "gmahota", "Accsys2011!","");
         }

        function daExtratoPdfCliente(empresa,cliente){
            console.log("da extrato do cliente " + cliente + " da empresa " + empresa);
            enviaEmail(cliente)
            rhHub.server.daExtratoPDFCliente(0, empresa, "gmahota", "Accsys2011!", cliente);
        }

    </script>
}

<ol id="listaEmpresas" class="breadcrumb"></ol>

<!-- Page Heading -->
<div id="listaFuncionarios" class="row" style="display:none">
    <div class="panel panel-info ">
        <div id="codigoEmpresa" class="panel-heading">Empresa Acc</div>

        <div class="panel-body">
            <p>
                <b>Nome: </b>
                <text id="nomeEmpresa"> </text>
            </p>
            <p>
                <b>NUIT: </b>
                <text id="nuitEmpresa"> </text>
            </p>

        </div>

    </div>

    <div class="col-md-5">
        <table id="tableListaFuncionarios" class="table table-striped">
            <tr></tr>

        </table>
    </div>


</div>