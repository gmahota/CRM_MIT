

@{
    ViewBag.Title = "Pagina de Cobrancas";
}


@section scripts {
    


    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.min.js"></script>
    
    <!--Reference the SignalR library. -->
    <script src="http://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:8989/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $.connection.hub.url = "http://localhost:8989/signalr";

            var cobrancasHub = $.connection.cobrancas;

        $(function () {

            cobrancasHub.client.daExtratoPDFCliente = function(val){
                console.log("Connection started! Extrato Cliente");
                console.log(val);
            }

            cobrancasHub.client.daListaEmpresas = function (val) {
                console.log("Connection started! client");
                console.log(val);
                $("#listaEmpresas").empty();

                val.forEach(preencherEmpresas);

                function preencherEmpresas(value, index, ar) {

                    $("#listaEmpresas").append(
                        $('<li>').append(
                            $('<a>').attr('onclick',"daClientes('"+ value.codigo +"')").append(value.codigo)

                        )
                    );
                }
            };

            cobrancasHub.client.daDadosEmpresa = function (val) {
                console.log("Connection started! - da dados da empresa "+ val.codigo);

                $("#codigoEmpresa").empty();
                $("#nomeEmpresa").empty();
                $("#nuitEmpresa").empty();

                $("#codigoEmpresa").text(val.codigo);
                $("#nomeEmpresa").text(val.nome);
                $("#nuitEmpresa").text(val.nuit);
            };

            cobrancasHub.client.daListaClientes = function(val){
                console.log("Connection started! client - Lista Clientes");
                console.log(val);
                $("#tableListaClientes").empty();

                $("#tableListaClientes").append("<tr> <th> Sel. </th> <th> Entidade  </th> <th> Nome </th> <th> ValorPendente </th>  <th> Contactos </th> <th></th> </tr>");

                val.forEach(preencheClientes);

                function preencheClientes(value, index, ar){

                    var contacto="";

                    value.contactos.forEach(daContactos)

                    $("#tableListaClientes").append("<tr> <td>" +
                        "<input name='enviaCobranca' checked='" + value.enviaCobranca + "' type='checkbox' value='"+value.entidade+"' />" +
                        "</td> <td> <a href='#' onclick= daExtratoPdfCliente('" + $("#codigoEmpresa").text() +"','"+ value.entidade +"')>" +value.entidade+ "</a></td> <td>"+ value.nome +"</td> <td>"+ value.valorPendente.toFixed(2)+" </td>  <td>   " + contacto+"</td>" +
                        
                        "<td id = 'enviaEmail_"+ value.entidade + "'><td> </tr>");

                    function daContactos(value, index, ar){
                        if (value != null) {
                            contacto = contacto + value.Email + "; ";
                        }

                    }

                     console.log();
                }


            }

            $.connection.hub.start().done(function () {
                cobrancasHub.server.daListaEmpresas(0,"gmahota","Accsys2011!","");
                console.log("connection started! server");


            });
        });

        function enviaEmail(cliente) {
            $.ajax({
                type: "Post",
                url: "/Cobrancas/EnviaEmail",
                data: { client: cliente },
                datatypr: "html",
                success: function (data) {
                    $("#enviaEmail_" + cliente).append("<p>" +data.Message+"</p>");

                }

            });

        }

        function botaoEnviaEmails() {

            var row = document.getElementById("tableListaClientes").rows.length;
         
            $('#tableListaClientes tr').each(function (i, row) {
               
                var row = $(this);
                if (row.find('input[type="checkbox"]').is(':checked') ) {

                    row.find('input[type="checkbox"]').each(function (i, val) {
                        $checkbox = val;
                        console.log($checkbox.value);

                    });
                }


                
            });

            for (i = 1; i < row; i++) {
                //console.log('Row ' + parseFloat(i + 1) + ' : ' + document.getElementById('tableListaClientes').rows[i].cells.item[1].firstChild.value);
            }
            //enviaEmail("1004");

        }

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

        function daClientes(empresa){
                console.log("da clientes da empresa " + empresa);
                cobrancasHub.server.daDadosEmpresa(0,empresa,"gmahota","Accsys2011!");
                cobrancasHub.server.daListaClientes(0,empresa,"gmahota","Accsys2011!");
         }

        function daExtratoPdfCliente(empresa,cliente){
             console.log("da extrato do cliente " + cliente+ " da empresa " + empresa);
             cobrancasHub.server.daExtratoPDFCliente(0,empresa,"gmahota","Accsys2011!",cliente);
        }

    </script>
}

<ol id="listaEmpresas" class="breadcrumb"></ol>

<!-- Page Heading -->
<div id="listaClientes" class="row">
    <div class="panel panel-info ">
        <div id="codigoEmpresa" class="panel-heading">Empresa Acc</div>

        <div class="panel-body">
            <p>
                <b>Nome: </b>
                <text id="nomeEmpresa"> </text>
            </p>
            <p>
                <b>NUIT: </b>
                <text id="nuitEmpresa"> </text>
            </p>

            <p><a href="#" class="btn btn-primary" role="button" onclick="botaoEnviaEmails()">Enviar Email</a> </p>
        </div>

    </div>


    <div class="col-md-5">
        <table id="tableListaClientes" class="table table-striped">
            <tr></tr>

        </table>
    </div>


</div>
