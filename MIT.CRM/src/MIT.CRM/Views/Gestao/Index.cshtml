@*
    For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    // ViewBag.Title = "Home Page";
}


@section scripts {

    
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $.connection.hub.url = "http://192.168.3.16:8989/signalr";

            var rhHub = $.connection.rhHub;

        $(function () {

            rhHub.client.daListaEmpresas = function (val) {
                console.log("Connection started! client");
                console.log(val);
                $("#tabelaEmpresas").empty();

                val.forEach(preencherEmpresas);

                function preencherEmpresas(value, index, ar) {

                    $("#tabelaEmpresas").append(
                            "<tr>" +
                                "<td> <a href='#' onclick= preencheDadosEmpresa('" + value.codigo + "') >" + value.codigo + "</a></td> " +
                                "<td>" + value.nome + "</td> " +
                                "<td id='btSave" + value.codigo + "' class = 'listBtSave'> </td>" +
                            "</tr>"
                        );
                }
            };

            rhHub.client.daDadosEmpresa = function (val) {
                console.log("Connection started! - da dados da empresa "+ val.codigo);

                $("#divDadosEmpresa").show();

                $("#codigo").val(val.codigo);
                $("#nome").val(val.nome);

            };

            rhHub.client.daListaFuncionarios = function (val) {
                console.log("Connection started! client - Lista Funcionarios");
                console.log(val);
                $("#tableListaFuncionarios").empty();

                $("#tableListaFuncionarios").append("<tr> <th> Codigo  </th> <th> Funcionario </th> <th> Departamento </th>  <th> Email </th> <th> Nr. Telefone</th> </tr>");

                val.forEach(preencheFuncionarios);

                function preencheFuncionarios(value, index, ar){

                    $("#tableListaFuncionarios").append(
                        "<tr>" +
                            "<td>" +
                                "<a href='#' onclick= daExtratoPdfCliente('" + $("#codigoEmpresa").text() + "','" + value.codigo + "')>" + value.codigo + "</a>" +
                            "</td> " +
                            "<td> " + value.nome + " </td> " +
                            "<td> " + value.departamentoId + "</td>" +
                            "<td id='email'>" + value.email + " </td>  "+
                            "<td> " + value.telemovel + "</td>" +
                        "</tr>"
                    );


                     console.log();
                }


            }

            rhHub.client.daListaDepartamentos = function (val) {
                console.log("Connection started! client - Lista Departamentos");
                console.log(val);

                $("#tableListaDepartamentos").empty();

                $("#tableListaDepartamentos").append("<tr> <th> Departamento  </th> <th> Descrição </th> </tr>");

                val.forEach(preencheDepartamento);

                function preencheDepartamento(value, index, ar) {

                    //var funcionarios = "";

                    //value.contacto.forEach(daContactos)

                    $("#tableListaDepartamentos").append(
                        "<tr> " +
                            "<td>" + value.departamento + "</td>" +
                            "<td>" + value.descricao + "</td>" +
                        "</tr>"
                    );

                    //function daContactos(value, index, ar){
                    //    if (value != null) {
                    //        contacto = contacto + value.Email + "; ";
                    //    }

                    //}

                    //console.log();
                }


            }

            $.connection.hub.start().done(function () {
                console.log("connection started! server");


            });
        });

        function listaEmpresas()
        {
            rhHub.server.daListaEmpresas(0, "gmahota", "Accsys2011!", "");
        }

        function enviaEmail(cliente,ficheiro) {
            $.ajax({
                type: "Post",
                url: "/RH/EnviaEmail",
                data: { client: cliente, ficheiro: ficheiro  },
                datatypr: "html",
                success: function (data) {
                    $("#enviaEmail_" + cliente).append("<p>" +data.Message+"</p>");

                }

            });

        }

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

        function daFuncionarios(empresa){
            rhHub.server.daListaFuncionarios(0, empresa, "gmahota", "Accsys2011!", "");
        }

        function preencheDadosEmpresa(empresa) {
            console.log("da Lista de Funcionarios da empresa " + empresa);
            rhHub.server.daDadosEmpresa(0, empresa, "gmahota", "Accsys2011!");
            daFuncionarios(empresa);
            daListaDepartamentos(empresa)

            $(".listBtSave").empty();
            $("#btSave" + empresa).append("<a onclick= 'importarDadosEmpresa()'  class='btSave glyphicon glyphicon-floppy-save' style=' color:red'></a>");
            
            
        }

        function daListaDepartamentos(empresa) {
            console.log("Connection started! Server - Lista Departamentos");
            rhHub.server.daListaDepartamentos(0, empresa, "gmahota", "Accsys2011!","");

        }

        function daExtratoPdfCliente(empresa,cliente){
            console.log("da extrato do cliente " + cliente + " da empresa " + empresa);
            enviaEmail(cliente)
            rhHub.server.daExtratoPDFCliente(0, empresa, "gmahota", "Accsys2011!", cliente);
        }

        function importarDadosEmpresa() {

            GravarEmpresa();
            GravarDepartamentos();
            GravarFuncionarios();

        }
        
        function GravarEmpresa() {

            var source = {
                'codigo': $("#codigo").val(),
                'nome': $("#nome").val()
            };

            var apiUrl = location.origin + "/Empresa/Create";

            $.ajax({
                type: "POST",
                dataType: "json",
                url: apiUrl,
                data: source,
                success: function (data) {
                    alert(data);
                },
                error: function (error) {
                    var x = error; //break here for debugging.
                }
            });

        }

        function GravarDepartamentos() {

            var apiUrl = location.origin + "/Departamento/Create";

            var row = document.getElementById("tableListaDepartamentos").rows.length;

            $('#tableListaDepartamentos tr').each(function (i, row) {

                var row = $(this);
                if (i != 0 ) {
                    
                    var td = row.children('td');


                    var source = {
                        'empresaId': $("#codigo").val(),
                        'departamento':td.eq(0).text(),
                        'descricao': td.eq(1).text()
                    };

                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        url: apiUrl,
                        data: source,
                        success: function (data) {
                            //alert(data);
                        },
                        error: function (error) {
                            var x = error; //break here for debugging.
                        }
                    });
                }



            });
        }

        function GravarFuncionarios() {

            var apiUrl = location.origin + "/Funcionario/Create";

            var row = document.getElementById("tableListaFuncionarios").rows.length;

            $('#tableListaFuncionarios tr').each(function (i, row) {

                var row = $(this);
                if (i != 0) {

                    var td = row.children('td');


                    var source = {
                        'codigo': td.eq(0).text(),
                        'nome': td.eq(1).text(),
                        'departamento': td.eq(2).text(),
                        'email': td.eq(3).text(),
                        'telemovel': td.eq(4).text(),
                        'empresaId': $("#codigo").val()
                    };

                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        url: apiUrl,
                        data: source,
                        success: function (data) {
                            //alert(data);
                        },
                        error: function (error) {
                            var x = error; //break here for debugging.
                        }
                    });
                }



            });
        }
    </script>
}


<div class="row" style="padding-top:20px;padding-bottom:20px" >
    
    <div class="col-md-4">
         
        <a href="#" onclick="listaEmpresas()"> 
            <span class="glyphicon glyphicon-plus " aria-hidden="true"></span>
            Dados do Primavera
        </a>
        
    </div>
    <div class="col-md-4">
        
    </div>
</div>

<div class="row">
    <div id="divlistaEmpresas" class="col-md-8">
        <table id="tabelaEmpresas" class="table table-striped">
            
            
        </table>
    </div>

    
</div>
<div class="row">
    <div id="divDadosEmpresa" class="col-md-8" style="display:none">
        <div>

            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#dadosEmpresa" aria-controls="dadosEmpresa" role="tab" data-toggle="tab">Dados Empresa</a></li>
                <li role="presentation"><a href="#departamentos" aria-controls="departamentos" role="tab" data-toggle="tab">Departamentos</a></li>

                <li role="presentation"><a href="#funcionariosActivos" aria-controls="funcionariosActivos" role="tab" data-toggle="tab">Funcionarios </a></li>
                @*<li role="presentation"><a href="#observacoes" aria-controls="observacoes" role="tab" data-toggle="tab">Observações</a></li>*@
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="dadosEmpresa">
                    <div class="col-md-8">
                        <form>
                            <div class="form-group">
                                <label for="codigo">Codigo</label>
                                <input type="text" class="form-control" id="codigo" placeholder="Codigo">
                            </div>
                            <div class="form-group">
                                <label for="nome">Nome</label>
                                <input type="text" class="form-control" id="nome" placeholder="Nome">
                            </div>
                            @*<button type="submit" class="btn btn-default">Submit</button>*@
                        </form>
                    </div>

                </div>


                <div role="tabpanel" class="tab-pane" id="departamentos">
                    <div class="col-md-8">
                        <div id="listaDepartamentos" style="padding-top:20px">

                            <table id="tableListaDepartamentos" class="table table-striped">
                                <tr></tr>

                            </table>
                        </div>

                    </div>
                </div>


                <div role="tabpanel" class="tab-pane" id="funcionariosActivos">
                    <div class="col-md-8">
                        <div id="listaFuncionarios" style="padding-top:20px">

                            <table id="tableListaFuncionarios" class="table table-striped">
                                <tr></tr>

                            </table>
                        </div>

                    </div>
                </div>


            </div>

        </div>
    </div>
</div>

